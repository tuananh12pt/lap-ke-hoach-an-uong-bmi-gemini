{% extends "base.html" %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-12 col-xl-11">
      <!-- Header Card with Stats -->
      <div class="card shadow-lg border-0 my-4 stats-card">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-md-6 mb-3 mb-md-0">
              <h2 class="mb-2 text-primary">
                <i class="bi bi-clipboard-check-fill me-2"></i>Kế hoạch dinh dưỡng
              </h2>
              <p class="text-muted mb-0">
                <i class="bi bi-calendar-week me-1"></i>7 ngày ăn uống & luyện tập cá nhân hóa
              </p>
            </div>
            <div class="col-md-6">
              <div class="row g-2">
                <div class="col-4">
                  <div class="stat-box bg-primary-subtle">
                    <div class="stat-icon text-primary">
                      <i class="bi bi-speedometer"></i>
                    </div>
                    <div class="stat-value text-primary">{{ bmi }}</div>
                    <div class="stat-label">BMI</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="stat-box bg-info-subtle">
                    <div class="stat-icon text-info">
                      <i class="bi bi-lightning-fill"></i>
                    </div>
                    <div class="stat-value text-info">{{ tdee }}</div>
                    <div class="stat-label">TDEE (kcal)</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="stat-box bg-success-subtle">
                    <div class="stat-icon text-success">
                      <i class="bi bi-bullseye"></i>
                    </div>
                    <div class="stat-value text-success">{{ target_cal }}</div>
                    <div class="stat-label">Mục tiêu (kcal)</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Card -->
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-body p-4">
          {# Check if plan contains table markup #}
          {% if '<table' in plan_text %}
            <div class="meal-table-wrapper">
              <div class="meal-table-header">
                <div class="d-flex justify-content-between align-items-center w-100 flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-calendar-week icon"></i>
                    <h4 class="mb-0">Kế hoạch dinh dưỡng 7 ngày</h4>
                  </div>
                  <!-- Quick Action Toolbar -->
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="toggleTableView()" title="Thu gọn/Mở rộng">
                      <i class="bi bi-arrows-collapse"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="copyTable()" title="Sao chép">
                      <i class="bi bi-clipboard"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="exportToCSV()" title="Xuất CSV">
                      <i class="bi bi-file-earmark-excel"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.print()" title="In">
                      <i class="bi bi-printer"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="table-responsive">
                {{ plan_text | safe }}
              </div>
              <!-- Table Footer Info -->
              <div class="table-footer-info">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  <strong>Mẹo:</strong> Click vào từng hàng để xem chi tiết, hover để làm nổi bật
                </small>
              </div>
            </div>
          {% elif '<div' in plan_text or '<h' in plan_text %}
            <div class="plan-output gemini-response">
              {{ plan_text | safe }}
            </div>
          {% else %}
            <div class="meal-table-wrapper">
              <div class="meal-table-header">
                <i class="bi bi-chat-left-text icon"></i>
                <h4>Kế hoạch dinh dưỡng của bạn</h4>
              </div>
              <div class="plan-output">
                <pre style="white-space: pre-wrap; font-family: 'Segoe UI', sans-serif;">{{ plan_text }}</pre>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="card shadow border-0 mb-4">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between flex-wrap gap-2">
            <a class="btn btn-outline-secondary btn-lg" href="/">
              <i class="bi bi-arrow-left-circle me-2"></i>Tạo kế hoạch mới
            </a>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-outline-info btn-lg" onclick="copyTable()" title="Sao chép bảng">
                <i class="bi bi-clipboard me-2"></i>Sao chép
              </button>
              <button class="btn btn-outline-success btn-lg" onclick="exportToCSV()" title="Xuất file Excel">
                <i class="bi bi-file-earmark-excel me-2"></i>Xuất CSV
              </button>
              <button class="btn btn-outline-warning btn-lg" onclick="toggleTableView()" title="Thu gọn/Mở rộng bảng">
                <i class="bi bi-arrows-collapse me-2"></i>Thu gọn
              </button>
              <button class="btn btn-outline-primary btn-lg" onclick="window.print();return false;" title="In kế hoạch">
                <i class="bi bi-printer-fill me-2"></i>In
              </button>
              <button class="btn btn-primary btn-lg" onclick="downloadPDF()" title="Tải xuống PDF">
                <i class="bi bi-download me-2"></i>Tải PDF
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function downloadPDF() {
      // Simple print to PDF
      window.print();
    }

    // Copy table to clipboard
    function copyTable() {
      const table = document.querySelector('.plan-output table');
      if (!table) {
        alert('Không tìm thấy bảng để sao chép!');
        return;
      }
      
      // Create a range and selection
      const range = document.createRange();
      range.selectNode(table);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
      
      try {
        document.execCommand('copy');
        window.getSelection().removeAllRanges();
        
        // Show success message
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Đã sao chép!';
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-info');
        }, 2000);
      } catch (err) {
        alert('Không thể sao chép. Vui lòng thử lại!');
      }
    }

    // Export table to CSV
    function exportToCSV() {
      const table = document.querySelector('.plan-output table');
      if (!table) {
        alert('Không tìm thấy bảng để xuất!');
        return;
      }

      let csv = [];
      const rows = table.querySelectorAll('tr');
      
      for (let row of rows) {
        const cols = row.querySelectorAll('td, th');
        const csvRow = [];
        for (let col of cols) {
          // Clean text and escape quotes
          let text = col.innerText.replace(/"/g, '""');
          csvRow.push('"' + text + '"');
        }
        csv.push(csvRow.join(','));
      }
      
      // Create blob and download
      const csvContent = '\uFEFF' + csv.join('\n'); // Add BOM for UTF-8
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'ke-hoach-dinh-duong.csv';
      link.click();
      
      // Show success message
      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Đã tải xuống!';
      btn.classList.remove('btn-outline-success');
      btn.classList.add('btn-success');
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
      }, 2000);
    }

    // Toggle table view (compact/expanded)
    let isCompact = false;
    function toggleTableView() {
      const table = document.querySelector('.plan-output table');
      if (!table) return;
      
      isCompact = !isCompact;
      const btn = event.target.closest('button');
      
      if (isCompact) {
        table.style.fontSize = '0.75rem';
        table.querySelectorAll('td, th').forEach(cell => {
          cell.style.padding = '0.5rem 0.35rem';
        });
        btn.innerHTML = '<i class="bi bi-arrows-expand me-2"></i>Mở rộng';
      } else {
        table.style.fontSize = '';
        table.querySelectorAll('td, th').forEach(cell => {
          cell.style.padding = '';
        });
        btn.innerHTML = '<i class="bi bi-arrows-collapse me-2"></i>Thu gọn';
      }
    }

    // Highlight row on click
    function setupTableInteraction() {
      const rows = document.querySelectorAll('.plan-output table tbody tr');
      rows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', function() {
          // Remove previous highlight
          rows.forEach(r => r.classList.remove('table-active'));
          // Add highlight to clicked row
          this.classList.add('table-active');
        });
      });
    }
    
    // Add fade-in animation and setup interactions
    document.addEventListener('DOMContentLoaded', function() {
      const elements = document.querySelectorAll('.card');
      elements.forEach((el, index) => {
        setTimeout(() => {
          el.style.animation = 'fadeInUp 0.5s ease forwards';
        }, index * 100);
      });

      // Setup table interactions
      if (document.querySelector('.plan-output table')) {
        setupTableInteraction();
      }
    });
  </script>
{% endblock %}
